<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Consentimento - Assistente de IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto">
        <!-- Configuration Section (edit these variables) -->
        <script>
            // ===== CONFIGURAÇÃO VIA URL PARAM =====
            // Usage: ?d=clarissa or ?d=roberto
            let CONFIG = null;
            const urlParams = new URLSearchParams(window.location.search);
            const doctorId = urlParams.get('d');
        </script>

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
                Termo de Consentimento para Uso de Assistente de Inteligência Artificial
            </h1>
            <p class="text-gray-600">
                <span id="clinicName"></span> - <span id="doctorName"></span>
            </p>
        </div>

        <!-- Consent Form Container -->
        <div id="consentFormContainer" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <!-- Consent Text -->
            <div class="prose prose-sm max-w-none mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Informações sobre o Uso de IA</h2>
                
                <div class="text-gray-700 space-y-4 text-sm md:text-base">
                    <p>
                        Prezado(a) paciente ou responsável legal,
                    </p>
                    
                    <p>
                        Informamos que <strong><span id="doctorName2"></span></strong> utiliza um assistente de inteligência artificial 
                        chamado <strong>"<span id="botName"></span>"</strong> como ferramenta de apoio no atendimento médico.
                    </p>
                    
                    <h3 class="font-semibold text-gray-800 mt-4 mb-2">Finalidades do Uso:</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Organização e estruturação de anotações clínicas</li>
                        <li>Geração de orientações e materiais educativos personalizados</li>
                        <li>Auxílio na elaboração de resumos e relatórios médicos</li>
                        <li>Otimização do tempo de atendimento para maior atenção ao paciente</li>
                    </ul>
                    
                    <h3 class="font-semibold text-gray-800 mt-4 mb-2">Importante Ressaltar:</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>A decisão médica final é sempre humana.</strong> A IA é apenas uma ferramenta de apoio.</li>
                        <li>O diagnóstico, prescrição e conduta médica são de exclusiva responsabilidade do médico.</li>
                        <li>Seus dados são tratados com sigilo e segurança, em conformidade com a LGPD.</li>
                        <li>As informações clínicas não são compartilhadas com terceiros não autorizados.</li>
                        <li>Você pode solicitar a exclusão dos seus dados a qualquer momento.</li>
                    </ul>
                    
                    <h3 class="font-semibold text-gray-800 mt-4 mb-2">Base Legal:</h3>
                    <ul class="list-disc pl-5 space-y-1 text-xs md:text-sm">
                        <li><strong>LGPD</strong> (Lei Geral de Proteção de Dados - Lei 13.709/2018): 
                            Tratamento de dados pessoais com consentimento e para finalidades legítimas</li>
                        <li><strong>Resolução CFM nº 1.821/2007</strong>: 
                            Normas técnicas concernentes à digitalização e uso dos sistemas informatizados para a guarda e manuseio dos documentos dos prontuários dos pacientes</li>
                        <li><strong>Código de Ética Médica</strong>: 
                            Sigilo profissional e responsabilidade médica</li>
                    </ul>
                    
                    <p class="mt-4">
                        <strong>Este consentimento é voluntário</strong> e você pode revogá-lo a qualquer momento, 
                        sem prejuízo ao seu atendimento médico.
                    </p>
                </div>
            </div>

            <!-- Form Fields -->
            <form id="consentForm" class="space-y-4">
                <hr class="my-6">
                
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome Completo do Paciente/Responsável <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="fullName" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Digite o nome completo"
                    >
                </div>

                <div>
                    <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">
                        CPF <span class="text-gray-400 text-xs">(opcional)</span>
                    </label>
                    <input 
                        type="text" 
                        id="cpf"
                        maxlength="14"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="000.000.000-00"
                    >
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                        E-mail <span class="text-gray-400 text-xs">(opcional)</span>
                    </label>
                    <input 
                        type="email" 
                        id="email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="[email protected]"
                    >
                </div>

                <!-- Consent Checkbox -->
                <div class="flex items-start space-x-3 p-4 bg-blue-50 rounded-md">
                    <input 
                        type="checkbox" 
                        id="consentCheck" 
                        required
                        class="mt-1 h-5 w-5 text-blue-600 focus:ring-2 focus:ring-blue-500 border-gray-300 rounded"
                    >
                    <label for="consentCheck" class="text-sm text-gray-700 cursor-pointer">
                        <strong>Li e concordo com os termos acima.</strong> 
                        Autorizo o uso de assistente de inteligência artificial como ferramenta de apoio 
                        no meu atendimento médico, conforme descrito neste documento.
                    </label>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-200 shadow-md hover:shadow-lg"
                >
                    Confirmar Consentimento
                </button>
            </form>
        </div>

        <!-- Confirmation Message (hidden initially) -->
        <div id="confirmationMessage" class="hidden bg-green-50 border-l-4 border-green-500 rounded-lg shadow-md p-6">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-green-500 mt-1 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">
                        ✓ Consentimento Registrado com Sucesso
                    </h3>
                    <div class="text-green-700 text-sm space-y-1">
                        <p><strong>Nome:</strong> <span id="confirmedName"></span></p>
                        <p><strong>Data e Hora:</strong> <span id="confirmedTimestamp"></span></p>
                        <p><strong>Identificador:</strong> <span id="confirmedId" class="font-mono text-xs"></span></p>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">
                        Seu consentimento foi registrado. Você pode solicitar uma cópia ou revogação a qualquer momento.
                    </p>
                    <button 
                        onclick="resetForm()" 
                        class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium no-print"
                    >
                        ← Registrar Outro Consentimento
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-xs text-gray-500 mt-6 no-print">
            <p>Em conformidade com a LGPD (Lei 13.709/2018) e resoluções do CFM</p>
        </div>
    </div>

    <script>
        // Load doctor config from URL param
        async function loadConfig() {
            if (!doctorId) {
                document.querySelector('.max-w-2xl').innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Termo de Consentimento</h1>
                        <p class="text-gray-600 mb-2">Link inválido. Este formulário requer um identificador de médico.</p>
                        <p class="text-gray-400 text-sm">Solicite o link correto ao seu médico.</p>
                        <div class="mt-6 text-xs text-gray-400">
                            <a href="https://botnursery.ai" class="text-blue-500 hover:underline">BotNursery</a> — A Consaience Company
                        </div>
                    </div>`;
                return;
            }
            try {
                const resp = await fetch('./doctors.json');
                const doctors = await resp.json();
                CONFIG = doctors[doctorId];
                if (!CONFIG) {
                    document.querySelector('.max-w-2xl').innerHTML = `
                        <div class="bg-white rounded-lg shadow-md p-8 text-center">
                            <h1 class="text-2xl font-bold text-gray-800 mb-4">Médico não encontrado</h1>
                            <p class="text-gray-600">O identificador "<strong>${doctorId}</strong>" não foi reconhecido.</p>
                            <p class="text-gray-400 text-sm mt-2">Solicite o link correto ao seu médico.</p>
                            <div class="mt-6 text-xs text-gray-400">
                                <a href="https://botnursery.ai" class="text-blue-500 hover:underline">BotNursery</a> — A Consaience Company
                            </div>
                        </div>`;
                    return;
                }
                populateForm();
            } catch (e) {
                console.error('Error loading config:', e);
            }
        }

        function populateForm() {
            document.getElementById('doctorName').textContent = CONFIG.doctorName;
            document.getElementById('doctorName2').textContent = CONFIG.doctorName;
            document.getElementById('clinicName').textContent = CONFIG.clinicName;
            document.getElementById('botName').textContent = CONFIG.botName;
        }

        loadConfig();

        // CPF Mask
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            }
        });

        // Form submission
        document.getElementById('consentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = {
                id: generateId(),
                config: {
                    doctorName: CONFIG.doctorName,
                    clinicName: CONFIG.clinicName,
                    botName: CONFIG.botName
                },
                fullName: document.getElementById('fullName').value.trim(),
                cpf: document.getElementById('cpf').value.trim() || null,
                email: document.getElementById('email').value.trim() || null,
                consentGiven: true,
                timestamp: new Date().toISOString(),
                timestampBR: formatBrazilianDateTime(new Date())
            };

            // Save to localStorage
            saveConsent(formData);

            // Show confirmation
            showConfirmation(formData);
        });

        function generateId() {
            return 'consent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatBrazilianDateTime(date) {
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/Sao_Paulo'
            });
        }

        function saveConsent(data) {
            // Get existing consents from localStorage
            let consents = [];
            try {
                const stored = localStorage.getItem('aiConsents');
                if (stored) {
                    consents = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading existing consents:', e);
            }

            // Add new consent
            consents.push(data);

            // Save back to localStorage
            try {
                localStorage.setItem('aiConsents', JSON.stringify(consents));
                console.log('Consent saved successfully:', data);
            } catch (e) {
                console.error('Error saving consent:', e);
                alert('Erro ao salvar consentimento. Por favor, tente novamente.');
            }
        }

        function showConfirmation(data) {
            // Hide form
            document.getElementById('consentFormContainer').classList.add('hidden');
            
            // Populate confirmation
            document.getElementById('confirmedName').textContent = data.fullName;
            document.getElementById('confirmedTimestamp').textContent = data.timestampBR;
            document.getElementById('confirmedId').textContent = data.id;
            
            // Show confirmation
            document.getElementById('confirmationMessage').classList.remove('hidden');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            // Reset form
            document.getElementById('consentForm').reset();
            
            // Show form, hide confirmation
            document.getElementById('consentFormContainer').classList.remove('hidden');
            document.getElementById('confirmationMessage').classList.add('hidden');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Export function for future backend integration
        function exportConsents() {
            try {
                const stored = localStorage.getItem('aiConsents');
                if (stored) {
                    const consents = JSON.parse(stored);
                    const dataStr = JSON.stringify(consents, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `consents_${Date.now()}.json`;
                    link.click();
                }
            } catch (e) {
                console.error('Error exporting consents:', e);
            }
        }

        // Make export function available globally (for debugging/admin use)
        window.exportConsents = exportConsents;
        
        console.log('AI Consent Form loaded. Config:', CONFIG);
        console.log('To export all consents, run: exportConsents()');
    </script>
</body>
</html>
